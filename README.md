# 搜索引擎项目报告


> 周天泽    2019011288    计94
> 王通泽    2019011299    计94


## 一、选题介绍
本项目是一个司法案例搜索引擎，共有搜索首页、搜索结果页和案例详情页三个用户界面，提供了关键词检索、案例检索、精细化检索三种检索方式，对搜索结果进行关键词高亮和标签显示，同时基于词向量、法院、法官、法条、案由等信息实现了五种相似案例推荐。
在技术栈层面，前端使用 [`Vue 3`]((https://vuejs.org/))，后端使用 [`Django`](https://docs.djangoproject.com/zh-hans/4.0/) + [`Elasticsearch`](https://www.elastic.co/guide/index.html)。

## 二、前端模块

> 前端框架为 [`Vue 3`](https://vuejs.org/)，UI 框架为 [`PrimeVUE`](https://www.primefaces.org/primevue/)，加入 Typescript 、[SASS](https://sass-lang.com/) 支持，通过 [Vue Router](https://router.vuejs.org/) 实现 Single Page Application，通过 [Pinia](https://pinia.vuejs.org/) 实现跨页面全局存储和持久化存储（[`pinia-plugin-persistedstate`](https://www.npmjs.com/package/pinia-plugin-persistedstate)）。

### 首页

![image.png](https://s2.loli.net/2022/06/07/MfWqNm1JwdhLb7X.png)

首页支持全部三种检索方式：
- 关键词检索：在输入框输入字段，点击搜索按钮或回车即可跳转至搜索结果页进行搜索
- 案例检索：点击搜索框右侧的文件夹图标：
  <img src="https://s2.loli.net/2022/06/07/ZUBg7aR9pSyzEkv.png" style="width: 70%">
  即可出现上传文件的对话框：
  <img src="https://s2.loli.net/2022/06/07/cZGSnFQDk6UptJf.png" style="width: 60%">
  点击 `Choose` 选择文件（xml 格式），`Upload` 上传并跳转至搜索结果页进行搜索
- 精细化检索：点击高级搜索会出现更多选项：
  ![image.png](https://s2.loli.net/2022/06/07/teHzSNEWfi1j4x7.png)
  用户输入完成后即可点击搜索按钮进行搜索，其中有下拉框的支持多选，不填写或不选择的项会自动忽略。

Pinia 及其持久化存储使得应用在从其他页面返回时也可记忆搜索内容，高级搜索的更多选项仅在上一搜索为高级搜索时展开。

### 搜索结果页

![image.png](https://s2.loli.net/2022/06/07/QcxmTbp4OltrHK5.png)

搜索结果页的搜索框与首页的搜索框为同一组件，UI/UX 均相同。

搜索结果经过后端分页后返回给前端（每页 10 项），每项结果取案例的法院、文书名称、案号作为标题，并列出搜索关键词的高亮（若为根据案例文件搜索则为诉讼记录）和案件的一些属性。

### 案例详情页
![image.png](https://s2.loli.net/2022/06/07/lCxv6BGatUq3hJM.png)

案例详情页的搜索框与首页的搜索框为同一组件，UI/UX 均相同。

案例详情页同样取案例的法院、文书名称、案号作为标题，将文首及其他信息汇总展示在卡片中，接下来是法条、法官成员、案例全文和附加段。若该案例是搜索关键词搜到的，那么也会显示高亮信息。

右边栏为基于当前案例的 5 种相关推荐，每种推荐最多 20 条，每小页显示 5 条，可通过右上角的左右箭头来翻页。每条推荐都可点击进入对应的案例详情页。


## 三、后端API
### 接口设计
#### 根URL
API的根URL：`/api/`，以下API的URL均为根URL后的相对路径

#### 请求参数格式

- 所有 ***GET*** 请求的请求参数均为Query String Parameters，即url string的形式；
- **其余类型** 请求的参数content-type为application/json，即JSON格式

### 检索（关键字/高级）

API：`/api/search`
请求方式：`POST`
请求参数：

| 参数名      | 描述                         | 是否必选 |
| ----------- | ---------------------------- | -------- |
| `query` | 待全字段匹配的查询词 | 否       |
| `offset`      | 请求页码（第一页为0） | 否       |
| `SPCX` | `审判程序`字段查询词 | 否 |
| `AH` | `案号`字段查询词 | 否 |
| `AJLB` | `案件类别`字段查询词 | 否 |
| `JBFY` | `经办法院`字段查询词 | 否 |
| `FGCY` | `法官成员`字段查询词 | 否 |
| `WSZL` | `文书种类`字段查询词 | 否 |
| `AH` | `案号`字段查询词 | 否 |

返回：

```json
{
    "total": 检索结果的总数,
    "size": 每页的检索结果数量,
    "offset": 返回结果对应的页码,
    "data": 检索结果列表
}
```

### 案例检索

API：`/api/search-by-case`
请求方式：`POST`
请求参数：

| 参数名      | 描述                         | 是否必选 |
| ----------- | ---------------------------- | -------- |
| `xml_str` | 目标案例文件的原始`xml`文本 | 是       |

返回：

```json
{
    "total": 检索结果的总数,
    "size": 每页的检索结果数量,
    "offset": 返回结果对应的页码,
    "data": 检索结果列表
}
```

### 案例推荐
API：`/api/recommend`
请求方式：`POST`
请求参数：

| 参数名      | 描述                         | 是否必选 |
| ----------- | ---------------------------- | -------- |
| `id` | 目标案例导入`Elasticsearch`后在`index`中的`id` | 是       |

返回：

```json
{
    "total": 检索结果的总数,
    "size": 每页的检索结果数量,
    "offset": 返回结果对应的页码,
    "data": {
        'knn': 基于词向量的推荐结果,
        'AY': 基于案由的推荐结果,
        'JBFY': 基于经办法院的推荐结果,
        'FGCY': 基于法官成员的推荐结果,
        'FT': 基于法条的推荐结果
    }
}
```

### 案例详情
API：`/api/search-by-id`
请求方式：`GET`
请求参数：

| 参数名      | 描述                         | 是否必选 |
| ----------- | ---------------------------- | -------- |
| `id` | 目标案例导入`Elasticsearch`后在`index`中的`id` | 是       |

返回：

```json
{
    "data": 目标案例的详细信息
}
```

## 四、功能实现
我们从 `xml` 中提取出 `案由`、`法官` 等字段信息后，将 `xml` 格式的案例信息转换为 `json` 后导入 `Elasticsearch`，存入格式大致如下
```python
{
    "全文": {
        "文首": {
            "文书制作单位": "xxx",
            "法院文书种类": "xxx",
            "经办法院": "xxx",
            "文书名称": "xxx",
            "案号": "xxx",
            "案件类别": "xxx",
            "文书种类": "xxx",
            "审判程序": "xxx",
            "案件类型": "xxx",
            ...
        }，
        "当事人": "xxx",
        "诉讼记录": "xxx",
        "案件基本情况": "xxx",
        "裁判分析过程": "xxx",
        "判决结果": "xxx",
        "文尾": "xxx",
        "立案日期": "xxx",
        "文书是否模糊": "xxx",
        ...
    },
    "自定义_xxxx_xxxxxx": "xxx",
    ...
    "自定义_yyyy_yyyyyy": "xxx",
    "法条": ["xxx", ..., "xxx"],
    "案例属性": {
        "案件类别": "xxx",
        "文书种类": "xxx",
        "经办法院": "xxx",
        "法官成员": ["xxx", ..., "xxx"]
    },
    "vec": [x, ..., x]
}
```
导入数据时设置分词器模式为 `ik_max_word`，以此对尽可能多的词项构建索引；搜索时设置分词器模式为 `ik_smart`，以此匹配语义更完整的词项。
### 关键词检索
使用 `Full text queries` 方法下的 `query_string` 检索模式，该模式支持通配符和多字段检索。对于上述 `json` 结构，指定如下待检索字段即可对全部案例文本进行匹配
```python
fields=["自定义*", "全文*", "法条", "案例属性*"]
```
同时，指定如下待高亮字段即可得到全部匹配词项的高亮信息
```python
highlight={
    "fields": {
        "自定义*": {},
        "全文*": {},
        "法条": {},
        "案例属性*": {},
    }
},
```
之后，调用 `search` API 即可得到关键词检索结果。
### 案例检索
导入案例之前，从 `xml` 中提取 `全文` 字段的文本（包含案例全部正文文本），使用 `jieba` 对文本进行分词后去除停用词，利用[腾讯 AI Lab 预训练的 100 维词向量](https://ai.tencent.com/ailab/nlp/zh/download.html)将每个词项转化对应词向量，对所有词向量累加后取平均值作为案例的向量表示。在 `Elasticsearch` 中创建 `index` 时设置如下 `mappings` 格式
```python
mappings = {
    "properties": {
        "vec": {
            "type": "dense_vector",
            "dims": 100,
            "index": True,
            "similarity": "l2_norm"
        }
    }
}
```
对于上传的案例文件，使用同样方法得到待检索词向量，之后调用 `knn_search` API，指定搜索字段为 `vec` 即可得到词向量距离前 `Top k` 小的案例。

### 高级检索
关键词检索已经实现对 `query` 的全字段匹配，在高级检索中我们还可以对指定如下字段的取值（我们已经从已有的全部案例中统计出 `案件类别`、`审判程序`、`文书种类` 的全部待选值）
- `案号`
- `案由`
- `经办法院`
- `法官成员`
- `案件类别`：[行政案件, 刑罚变更案件, 民事案件, 执行案件, 刑事案件, 赔偿案件]
- `审判程序`：[特别程序案件, 刑罚变更案件, 复核案件, 二审案件, 强制医疗案件, 再审复查与审判监督案件, 再审案件, 破产案件, 非诉执行审查案件, 一审案件]
- `文书种类`：[调解书, 不起诉书, 起诉书, 应诉通知书, 裁定书, 决定书, 判决书, 起诉状, 暂予监外执行案例]

高级检索的实现思路为：沿用关键词检索的方法对 `query` 文本做全字段匹配，同时将上述字段的检索信息作为 `search` API的 `post_filter` 传入
```python
post_filter={"bool": {"must": filter_list}}
```
注意到我们对 `bool query` 使用 `must` 模式，这意味着高级检索的匹配程度将影响最终检索结果的得分。
此外，我们对上述字段采用如下三种筛选方式

- `案号`：该字段输入信息通常较为简短，简单使用如下 `match` 方式即可
```python
{"match": {"全文.文首.案号": body.get("AH", "")}}
```

- `案由`、`经办法院`：由于该字段的查询文本可能较长，例如输入 `贵州省黔南布依族苗族自治州中级人民法院` 时，`Elasticsearch` 的搜索策略是对分词得到词项进行匹配，且词项之间默认的逻辑关系是 `OR`，这会导致评分最高的检索结果往往和查询文本不是精确匹配。为了保证精确匹配，我们采用如下检索方式指定词项之间的逻辑关系为 `AND`

```python
{
    "match": {
        "案例属性.经办法院": {
            "query": body.get("JBFY", ""),
            "operator": "and"
        }    
    }
}
```
- `审判程序`、`案件类别`、`法官成员`、`文书种类`：这四个字段在检索时可能选择（或输入）多个查询选项（或文本），我们需要在兼顾上述的词项之间 `AND` 的逻辑关系的同时，保证多个选项之间的逻辑关系是 `OR`，由此实现精确匹配的同时保证搜索范围。为此，使用如下检索方式

```python
{
    "query_string": {
        "fields": ["案例属性.法官成员"],
        "query": " OR ".join(FGCY),
        "default_operator": "AND"
    }
}
```

### 智能推荐
#### 基于词向量的推荐
使用目标案例的词向量进行 `knn_search` 就能得到相似案例。值得注意的是，检索结果中评分最高的案例一定是目标案例本身。

#### 基于案由、经办法院、法官成员、法条的推荐
使用的检索方式与[高级检索](#高级检索)部分介绍的方法一致（`法条` 与 `法官成员`使用方法相同），最大的区别在于[高级检索](#高级检索)部分这些字段的检索信息通过 `post_filter` 传入，在推荐时通过 `query` 传入。





## 五、性能评价

下面将从关键词搜索、案例搜索两个维度，对我们的搜索引擎与[中国司法案例网](https://anli.court.gov.cn/)进行性能评价。

### 关键词

关键词选择 `沈阳 不良金融`，信息需求为想检索沈阳市的涉及不良金融债权的相关案例。

记录前 10 个结果

我们的搜索结果如下：

| 编号 | 标题 | 相关性 |
| -------- | -------- | -------- |
| 1   | 沈阳市和平区人民法院 民事判决书 （2017）辽0102民初7322号    | 相关  |
| 2   | 最高人民法院 民事判决书 （2014）民二终字第199号   | 相关  |
| 3   | 辽宁省高级人民法院 民事判决书 （2008）辽民二初字第5号 | 相关  |
| 4   | 黑龙江省高级人民法院 民事判决书 （2016）黑民终39号  | 不相关  |
| 5   |  广东省高级人民法院 民事裁定书 （2018）粤破终8号  | 不相关  |
| 6   |  吉林省长春市中级人民法院 民事判决书 （2017）吉01民初1783号  | 不相关  |
| 7   |  重庆市高级人民法院 民事判决书 （2018）渝民终466号  | 不相关  |
| 8   |  广东省惠州市惠城区人民法院 民事判决书 （2016）粤1302民初9740号  | 不相关  |
| 9   |  河北省石家庄市中级人民法院 民事判决书 （2012）石民三初字第00018号  | 不相关  |
| 10   |  甘肃省高级人民法院 民事裁定书 （2015）甘民二终字第59号  | 不相关  |

中国司法案例网的搜索结果如下（只搜索出 6 个结果，编号 2、3、4 为重复项）：

| 编号 | 标题 | 相关性 |
| -------- | -------- | -------- |
| 1   | 中国华融资产管理公司沈阳办事处与沈阳银盛天成投资管理有限公司债权转让纠纷申请再审案    | 相关  |
| 2   | 沈阳银胜天成投资管理有限公司与 中国华融资产管理公司沈阳办事处债权转让合同纠纷再审案  | 相关  |
| 3   | 沈阳银胜天成投资管理有限公司与中国华融资产管理公司沈阳办事处债权转让合同纠纷再审案 | 相关  |
| 4   | 沈阳银胜天成投资管理有限公司与 中国华融资产管理公司沈阳办事处债权转让合同纠纷再审案  | 相关  |
| 5   |  担保法前未约定保证期间，不适用6个月的规定  | 不相关  |
| 6   |  全民所有制企业清算主体、清算责任及法律适用  | 不相关  |
| 7   |  无  | 不相关  |
| 8   |  无  | 不相关  |
| 9   |  无  | 不相关  |
| 10   |  无  | 不相关  |

计算各评价指标：

| 搜索引擎 | 相关性序列 | AP@10 | P@10 | RR | success@10 |
| -------- | -------- | -------- | -------- | -------- | -------- |
| Ours     | 1110000000     | 1.0     |0.3 | 1.0| TRUE |
| 中国司法案例网 | 1111000000     | 1.0     | 0.4| 1.0| TRUE|

二者的表现都不是很好，中国司法案例网虽然指标更高，但其相关的 4 个结果中有 3 个的案号一致。后面的不相关案例或只有 `沈阳` 或只有 `不良金融`，若信息需求为二者的或那么我们的搜索引擎将有更高的分数（司法案例网后 4 个无结果）。

可以看到只用关键词检索复杂情况时的效果并不好，即使中国司法案例网也不能给出很好的结果，在复杂查询场景下仍需使用精细化检索。


### 案例

由于中国司法案例网的“以案搜案”功能无法正常使用，所以只对我们的搜索引擎进行评价。

案例选择数据集中名为 `84473.xml` 的文件，信息需求是：找到案由、案件类别、审判程序、经办法院、基本案情等指标半数以上相同的相似案例。

搜索结果如下：

| 编号 | 标题 | 相关性 |
| -------- | -------- | -------- |
| 1   | 重庆市高级人民法院 刑事判决书 （2014）渝高法刑终字第00075号    | 相关  |
| 2   | 四川省成都高新技术产业开发区人民法院 刑事判决书 （2017）川0191刑初657号   | 相关  |
| 3   | 湖南省郴州市中级人民法院 刑事判决书 （2016）湘10刑初37号 | 相关  |
| 4   | 重庆市高级人民法院 刑事裁定书 （2014）渝高法刑终字第00158号  | 相关  |
| 5   |  云南省高级人民法院 刑事裁定书 （2017）云刑终63号  | 相关  |
| 6   |  云南省高级人民法院 刑事裁定书 （2017）云刑终247号  | 不相关  |
| 7   |  云南省高级人民法院 刑事判决书 （2017）云刑终232号  | 相关  |
| 8   |  广东省佛山市中级人民法院 刑事判决书 （2004）佛刑初字第148号  | 相关  |
| 9   |  吉林省高级人民法院 刑事裁定书 （2016）吉刑终108号  | 不相关  |
| 10   |  黑龙江省高级人民法院 刑事裁定书 （2015）黑刑一终字第174号  | 不相关  |

评价指标计算如下：

| 相关性序列 | AP@10 | P@10 | RR | success@10 |
| -------- | -------- | -------- | -------- | -------- |
| 1111101100     | 0.96   | 0.7 | 1.0| TRUE |

可以发现相比于关键词搜索，案例搜索的 AP@10 和 P@10 都大幅提升，说明词向量 + KNN 的方法效果显著，有极大的利用空间。

同时尽管我们使用了词向量来做嵌入，但将所有词的向量直接求平均，遗失了词和词之间的关联信息。我们曾经尝试使用[预训练好的 Sentence BERT](https://huggingface.co/uer/sbert-base-chinese-nli) 进行句子嵌入，但在 Nvidia GeForce MX230 上用 CUDA 加速仍然很慢（10 秒左右），所以放弃了该方法，未来可以尝试案例搜索在大模型上应用的效果。


## 六、参考
本项目参考资料均为官方文档，来源如下

- https://vuejs.org/
- https://www.primefaces.org/primevue/
- https://sass-lang.com/
- https://router.vuejs.org/
- https://pinia.vuejs.org/
- https://www.npmjs.com/package/pinia-plugin-persistedstate
- https://docs.djangoproject.com/zh-hans/4.0/
- https://www.elastic.co/guide/en/elasticsearch/reference/current/index.html
- https://elasticsearch-py.readthedocs.io/en/v8.2.0/

本项目使用的中文预训练词向量来源如下
- https://ai.tencent.com/ailab/nlp/zh/download.html

首页的波浪效果：
- https://codepen.io/goodkatz/pen/LYPGxQz



